<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8" />
<!--   vendor css -->
<link href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="//cdnjs.cloudflare.com/ajax/libs/noUiSlider/3.1.1/nouislider.fox.min.css" rel="stylesheet" media="screen">
<!-- 	vendor js -->
<script src="../MooTools-Core-1.6.0.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.2.2/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/noUiSlider/3.1.1/jquery.nouislider.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<title>Realtime Bitcoin Transactions</title>
<div id="idcontrol">
    <div>
        <button id="start" onclick='start()'>Start</button>
        <button id="stop" onclick='stop()'>Stop</button>
    </div>
    <p id="status">Not connected</p>
    <p id="amount">-----</p>
</div>
<svg width="100%" height="35rem" id="bubbleCanvas" class="vizCanvas"></svg>
<script>
          var txNodes = [];
            
          var svg = d3.select("#bubbleCanvas"),
              width = +svg.attr("width"),
              height = +svg.attr("height");
          var centerX = width / 2.0;
          var centerY = height / 2.0;
          var counter = 0;
          
          var node = svg.append("g")
              .attr("class", "nodes")
              .selectAll("circle");
              
        var bubbleSimulation = d3.forceSimulation(txNodes)
            .force("charge", d3.forceManyBody().strength(-3))
            .force("x", d3.forceX())
            .force("y", d3.forceY())
            .force("collision", d3.forceCollide(function radius(d,i){return d.scaledValue;}))
            .alphaTarget(1)
            .on("tick", bubblesTicked);
                          
        		var websocket;
            
            function init() {          
              websocket = new WebSocket("wss://ws.blockchain.info/inv");
            
              websocket.onopen = function() { 
                document.getElementById("status").innerHTML ="Connected"; 
                };
                
             	websocket.onerror = function(event) { 
                document.getElementById("status").innerHTML = "Error"; 
              };

              websocket.onmessage = function(event) { 
              	//message processing code goes here
                var msgData = JSON.parse(event.data);
                if (msgData.op == 'utx'){   
                  var txHash = msgData.x.hash;
                	var outputs = msgData.x.out;
                  var totalTxValue = 0;               
                  for(var j=0;j<outputs.length;j++){
                		var output = outputs[j];
                    totalTxValue += output.value;
                	}
                  totalTxValue /= 100000000;
                  var newTx = {id:txHash, value: totalTxValue, scaledValue: 5 + Math.log(totalTxValue) };
                  txNodes.push(newTx);
                  if (txNodes.length > 400)
                  {
                  		txNodes.shift();
                  }
                  bubblesRestart();
                  document.getElementById("status").innerHTML = "tx: " + txHash;
                  document.getElementById("amount").innerHTML = "amount: " + totalTxValue + " BTC";

                }
              };                          
            };
    
            function sendMessage(message) {
              document.getElementById("output").innerHTML = message;      
              websocket.send(message);
            }
                        
        function bubblesRestart() {
          var updateSelection = node.data(txNodes, function(d) { return d.id;}); //updated transactions
        	updateSelection.exit().remove(); //removed transactions
          var enterSelection = updateSelection.enter()
          .append("circle")
          .attr("r", function(d){return d.scaledValue;})
          .attr("fill",function(d){return d3.hsl(180 + Math.min(d.value * 4, 180),1,0.5);}); //new transactions
          node = updateSelection.merge(enterSelection);
          bubbleSimulation.nodes(txNodes);
          bubbleSimulation.alpha(1).restart();
        }

         function bubblesTicked() {
            node.attr("cx", function(d) { return d.x + centerX; })
            .attr("cy", function(d) { return d.y + centerY; });
          }
            
            function start() {
            websocket.send('{"op":"unconfirmed_sub"}');
            }
            
            function stop() {
            	websocket.send('{"op":"unconfirmed_unsub"}');
            }
                  
            window.addEventListener("load", init, false);
        </script>
</body>

<style>
.vizCanvas {
    background-color:black;
    align-content: center;
    float: center;
  }
</style>
</html>
